"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var r=e.apply(this,arguments);return new Promise(function(e,t){function n(u,a){try{var o=r[u](a),i=o.value}catch(e){return void t(e)}if(!o.done)return Promise.resolve(i).then(function(e){n("next",e)},function(e){n("throw",e)});e(i)}return n("next")})}}function fields2Buf(e){var r="";for(var t in e)r+=""+splitBoundary+br,r+='Content-Disposition: form-data; name="'+t+'"'+br2,r+=""+e[t]+br;return toUTF8Bytes(r)}function getFileBuf(e){return new Promise(function(r){wx.getFileSystemManager().readFile({filePath:e,success:function(e){r(e.data)},fail:function(e){console.error(e.errMsg)}})})}function generateBoundary(){for(var e="----WebKitFormBoundary",r="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",t=r.length,n=0;n<16;n++)e+=r.charAt(~~(Math.random()*t));return e}function toUTF8Bytes(e){for(var r=[],t=0;t<e.length;t++){var n=e.charCodeAt(t);0<=n&&n<=127?r.push(n):128<=n&&n<=2047?(r.push(192|31&n>>6),r.push(128|63&n)):(2048<=n&&n<=55295||57344<=n&&n<=65535)&&(r.push(224|15&n>>12),r.push(128|63&n>>6),r.push(128|63&n))}for(var u=0;u<r.length;u++)r[u]&=255;return r}function getType(e){var r=e.lastIndexOf("."),t=e.substr(r+1);for(var n in _mimeDb2.default)if(void 0!==_mimeDb2.default[n].extensions&&-1!==_mimeDb2.default[n].extensions.indexOf(t))return n;return null}Object.defineProperty(exports,"__esModule",{value:!0}),exports.multipartUpload=void 0;var _extends=Object.assign||function(e){for(var r=1;r<arguments.length;r++){var t=arguments[r];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e},multipartUpload=exports.multipartUpload=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t,n=r.url,u=r.header,a=r.fields,o=r.files,i=r.success,s=r.fail;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,toBuf(a,o);case 2:return t=e.sent,e.abrupt("return",uni.request({url:n,data:t,method:"POST",header:_extends({},u,{"Content-Type":"multipart/form-data; boundary="+boundary}),success:function(e){i(e)},fail:function(e){s(e)}}));case 4:case"end":return e.stop()}},e,this)}));return function(r){return e.apply(this,arguments)}}(),toBuf=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){var n,u,a,o,i,s,f,c,l,p,d,m,h,y;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n=[],n.push(fields2Buf(r)),e.t0=regeneratorRuntime.keys(t);case 3:if((e.t1=e.t0()).done){e.next=20;break}return u=e.t1.value,a=t[u],o=getType(a),i="",s=a.match(/(?:(?!\/).)*$/),s&&(i=s[0]),f=""+splitBoundary+br+'Content-Disposition:form-data;name="'+u+'";filename="'+i+'"'+br,f+="Content-Type: "+o+br2,e.next=14,getFileBuf(a);case 14:c=e.sent,n.push(toUTF8Bytes(f)),n.push(new Uint8Array(c)),n.push(toUTF8Bytes(br)),e.next=3;break;case 20:for(n.push(toUTF8Bytes(splitBoundary+"--")),l=n.reduce(function(e,r){return e+r.length},0),p=new ArrayBuffer(l),d=new Uint8Array(p),m=0,h=0;h<n.length;h++){for(y=0;y<n[h].length;y++)d[m+y]=n[h][y];m+=n[h].length}return e.abrupt("return",p);case 27:case"end":return e.stop()}},e,this)}));return function(r,t){return e.apply(this,arguments)}}(),_mimeDb=require("mime-db"),_mimeDb2=_interopRequireDefault(_mimeDb),br="\r\n",br2="\r\n\r\n",boundary=generateBoundary(),splitBoundary="--"+boundary;