"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var r=e.apply(this,arguments);return new Promise(function(e,t){function n(o,u){try{var a=r[o](u),i=a.value}catch(e){return void t(e)}if(!a.done)return Promise.resolve(i).then(function(e){n("next",e)},function(e){n("throw",e)});e(i)}return n("next")})}}function convert2Buffer(e){for(var r=e.reduce(function(e,r){return e+r.length},0),t=new ArrayBuffer(r),n=new Uint8Array(t),o=0,u=0;u<e.length;u++){for(var a=0;a<e[u].length;a++)n[o+a]=e[u][a];o+=e[u].length}return t}function getFieldHeader(e,r){return""+splitBoundary+br+'Content-Disposition: form-data; name="'+e+'"'+br2+r+br}function getFileHeader(e,r){var t=getType(r),n=r.replace(/^(.*)\/(.*)/,"$2");return""+splitBoundary+br+'Content-Disposition: form-data; name="'+e+'"; filename="'+n+'"'+br+"Content-Type: "+t+br2}function generateBoundary(){for(var e="----WebKitFormBoundary",r="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",t=r.length,n=0;n<16;n++)e+=r.charAt(~~(Math.random()*t));return e}function str2Uint8Arr(e){for(var r=[],t=0;t<e.length;t++){var n=e.charCodeAt(t);0<=n&&n<=127?r.push(n):128<=n&&n<=2047?(r.push(192|31&n>>6),r.push(128|63&n)):(2048<=n&&n<=55295||57344<=n&&n<=65535)&&(r.push(224|15&n>>12),r.push(128|63&n>>6),r.push(128|63&n))}for(var o=0;o<r.length;o++)r[o]&=255;return r}function file2Uint8Arr(e){return new Promise(function(r){wx.getFileSystemManager().readFile({filePath:e,success:function(e){r(new Uint8Array(e.data))},fail:function(e){console.error(e.errMsg)}})})}function getType(e){var r=e.lastIndexOf("."),t=e.substr(r+1);if(commonTypes.hasOwnProperty(t))return commonTypes[t];for(var n in _mimeDb2.default)if(void 0!==_mimeDb2.default[n].extensions&&-1!==_mimeDb2.default[n].extensions.indexOf(t))return commonTypes[t]=n,n;return null}Object.defineProperty(exports,"__esModule",{value:!0}),exports.multipartUpload=void 0;var _extends=Object.assign||function(e){for(var r=1;r<arguments.length;r++){var t=arguments[r];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e},multipartUpload=exports.multipartUpload=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t,n,o=r.url,u=r.header,a=r.fields,i=r.files,s=r.success,f=r.fail,c=r.complete;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,toBuffer(a,i);case 2:return t=e.sent,n={url:o,data:t,method:"POST",header:_extends({},u,{"Content-Type":"multipart/form-data; boundary="+boundary})},(s||f||c)&&Object.assign(n,{success:function(e){s&&s(e)},fail:function(e){f&&f(e)},complete:function(e){c&&c(e)}}),e.abrupt("return",uni.request(n));case 6:case"end":return e.stop()}},e,this)}));return function(r){return e.apply(this,arguments)}}(),toBuffer=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){var n,o,u,a,i,s,f;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n=[],o="";for(u in r)o+=getFieldHeader(u,r[u]);n.push(str2Uint8Arr(o)),e.t0=regeneratorRuntime.keys(t);case 5:if((e.t1=e.t0()).done){e.next=17;break}return a=e.t1.value,i=t[a],s=getFileHeader(a,i),n.push(str2Uint8Arr(s)),e.next=12,file2Uint8Arr(i);case 12:f=e.sent,n.push(f),n.push(str2Uint8Arr(br)),e.next=5;break;case 17:return n.push(str2Uint8Arr(splitBoundary+"--")),e.abrupt("return",convert2Buffer(n));case 19:case"end":return e.stop()}},e,this)}));return function(r,t){return e.apply(this,arguments)}}(),_mimeDb=require("mime-db"),_mimeDb2=_interopRequireDefault(_mimeDb),br="\r\n",br2="\r\n\r\n",boundary=generateBoundary(),splitBoundary="--"+boundary,commonTypes={};