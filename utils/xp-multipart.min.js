"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var r=e.apply(this,arguments);return new Promise(function(e,n){function t(o,u){try{var a=r[o](u),i=a.value}catch(e){return void n(e)}if(!a.done)return Promise.resolve(i).then(function(e){t("next",e)},function(e){t("throw",e)});e(i)}return t("next")})}}function convert2Buffer(e){for(var r=e.reduce(function(e,r){return e+r.length},0),n=new ArrayBuffer(r),t=new Uint8Array(n),o=0,u=0;u<e.length;u++){for(var a=0;a<e[u].length;a++)t[o+a]=e[u][a];o+=e[u].length}return n}function getFieldHeader(e,r){return""+splitBoundary+br+'Content-Disposition: form-data; name="'+e+'"'+br2+r+br}function getFileHeader(e,r){var n=getType(r),t=r.replace(/^(.*)\/(.*)/,"$2");return""+splitBoundary+br+'Content-Disposition: form-data; name="'+e+'"; filename="'+t+'"'+br+"Content-Type: "+n+br2}function generateBoundary(){for(var e="----WebKitFormBoundary",r="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",n=r.length,t=0;t<16;t++)e+=r.charAt(~~(Math.random()*n));return e}function str2Uint8Arr(e){for(var r=[],n=0;n<e.length;n++){var t=e.charCodeAt(n);0<=t&&t<=127?r.push(t):128<=t&&t<=2047?(r.push(192|31&t>>6),r.push(128|63&t)):(2048<=t&&t<=55295||57344<=t&&t<=65535)&&(r.push(224|15&t>>12),r.push(128|63&t>>6),r.push(128|63&t))}for(var o=0;o<r.length;o++)r[o]&=255;return r}function file2Uint8Arr(e){return new Promise(function(r){wx.getFileSystemManager().readFile({filePath:e,success:function(e){r(new Uint8Array(e.data))},fail:function(e){console.error(e.errMsg)}})})}function getType(e){var r=e.lastIndexOf("."),n=e.substr(r+1);if(commonTypes.hasOwnProperty(n))return commonTypes[n];for(var t in _mimeDb2.default)if(void 0!==_mimeDb2.default[t].extensions&&-1!==_mimeDb2.default[t].extensions.indexOf(n))return commonTypes[n]=t,t;return null}Object.defineProperty(exports,"__esModule",{value:!0}),exports.multipartUpload=void 0;var _extends=Object.assign||function(e){for(var r=1;r<arguments.length;r++){var n=arguments[r];for(var t in n)Object.prototype.hasOwnProperty.call(n,t)&&(e[t]=n[t])}return e},multipartUpload=exports.multipartUpload=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var n,t=r.url,o=r.header,u=r.fields,a=r.files,i=r.success,s=r.fail,f=r.complete;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,toBuffer(u,a);case 2:return n=e.sent,e.abrupt("return",new Promise(function(e,r){wx.request({url:t,data:n,method:"POST",header:_extends({},o,{"Content-Type":"multipart/form-data; boundary="+boundary}),success:function(r){i&&i(r),e(r)},fail:function(e){s&&s(e),r(e)},complete:function(e){f&&f(e)}})}));case 4:case"end":return e.stop()}},e,this)}));return function(r){return e.apply(this,arguments)}}(),toBuffer=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r,n){var t,o,u,a,i,s,f;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:t=[],o="";for(u in r)o+=getFieldHeader(u,r[u]);t.push(str2Uint8Arr(o)),e.t0=regeneratorRuntime.keys(n);case 5:if((e.t1=e.t0()).done){e.next=17;break}return a=e.t1.value,i=n[a],s=getFileHeader(a,i),t.push(str2Uint8Arr(s)),e.next=12,file2Uint8Arr(i);case 12:f=e.sent,t.push(f),t.push(str2Uint8Arr(br)),e.next=5;break;case 17:return t.push(str2Uint8Arr(splitBoundary+"--")),e.abrupt("return",convert2Buffer(t));case 19:case"end":return e.stop()}},e,this)}));return function(r,n){return e.apply(this,arguments)}}(),_mimeDb=require("mime-db"),_mimeDb2=_interopRequireDefault(_mimeDb),br="\r\n",br2="\r\n\r\n",boundary=generateBoundary(),splitBoundary="--"+boundary,commonTypes={};